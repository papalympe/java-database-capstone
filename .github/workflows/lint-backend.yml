name: Lint Java Backend

on:
  push:
  pull_request:

jobs:
  lint-java:
    runs-on: ubuntu-latest
    name: Checkstyle Java Linting
    steps:
      - uses: actions/checkout@v3

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Create tools directory
        run: mkdir -p tools

      - name: Download Checkstyle (standalone jar)
        run: |
          CHECKSTYLE_VERSION=10.12.3
          curl -sSL -o tools/checkstyle-${CHECKSTYLE_VERSION}-all.jar \
            "https://github.com/checkstyle/checkstyle/releases/download/checkstyle-${CHECKSTYLE_VERSION}/checkstyle-${CHECKSTYLE_VERSION}-all.jar"

      - name: Extract google_checks.xml from Checkstyle jar (match versions)
        run: |
          CHECKSTYLE_JAR=tools/checkstyle-10.12.3-all.jar
          mkdir -p tools
          # try common paths inside jar
          if jar tf "$CHECKSTYLE_JAR" | grep -q "src/main/resources/google_checks.xml"; then
            unzip -p "$CHECKSTYLE_JAR" "src/main/resources/google_checks.xml" > tools/google_checks.xml
          elif jar tf "$CHECKSTYLE_JAR" | grep -q "google_checks.xml"; then
            unzip -p "$CHECKSTYLE_JAR" "google_checks.xml" > tools/google_checks.xml
          else
            echo "google_checks.xml not found inside jar; falling back to remote download"
            curl -sSL -o tools/google_checks.xml \
              "https://raw.githubusercontent.com/checkstyle/checkstyle/checkstyle-10.12.3/src/main/resources/google_checks.xml"
          fi

      - name: Run Checkstyle on back-end Java sources
        run: |
          CHECKSTYLE_JAR=tools/checkstyle-10.12.3-all.jar
          TARGET_DIR=app/src/main/java/com/project/back_end

          if [ -d "$TARGET_DIR" ]; then
            echo "Running Checkstyle against $TARGET_DIR"
            # produce XML report; step fails if violations found
            java -jar "$CHECKSTYLE_JAR" -c tools/google_checks.xml -f xml -o tools/checkstyle-report.xml "$TARGET_DIR"
          else
            echo "Target directory $TARGET_DIR not found; skipping Checkstyle run"
          fi

      - name: Upload Checkstyle report
        uses: actions/upload-artifact@v4
        with:
          name: checkstyle-report
          path: tools/checkstyle-report.xml
